#include "lp_primal_dual_solver.h"
#include <stdio.h>
#include <stdlib.h>

void stack_test() {
  IdxStack_t test = {malloc(sizeof(IDX) * 2), malloc(sizeof(IDX) * 2), 2, 0};
  IdxStack_init(&test);
  IdxStack_push(&test, 7);
  IdxStack_print(&test);
  IdxStack_push(&test, 2);
  IdxStack_print(&test);
  printf("pop %lu\n", IdxStack_pop(&test));
  IdxStack_print(&test);
}

void gauss_jordan_test() {
  FPN data[] = {2.0, 3.0, 5.0, 4.0, 1.0, 9.0, 7.0, 6.0, 8.0, 2.0,
                7.0, 9.0, 1.0, 8.0, 3.0, 1.0, 5.0, 1.0, 2.0, 3.0};
  GJTab_t tab = {&data, 4};
  // GJTab_print(&mat);

  IdxStack_t pivots = {malloc(sizeof(IDX) * tab.N),
                       malloc(sizeof(BYTE) * tab.N), tab.N, 0};
  FPN sol[4] = {0};
  gauss_jordan(&tab, &pivots, sol);

  printf("Got: ");
  for (IDX k = 0; k < tab.N; k++) {
    printf("%05.4lf ", sol[k]);
  }
  printf("\nExpected: -0.05128205  0.76923077  0.12820513 -0.46153846\n");
}

void dual_solve_test_general(FPN *Aptr, FPN *bptr, FPN *cptr, IDX N, IDX M) {

  LPDef_t lp = {Aptr, bptr, cptr, N, M};

  unsigned long fps = sizeof(FPN);
  IDX Ngrad = N + 2 * M;
  GJTab_t tab = {malloc(fps * Ngrad * (Ngrad + 1)), Ngrad};
  IdxStack_t pivots = {malloc(sizeof(IDX) * tab.N),
                       malloc(sizeof(BYTE) * tab.N), tab.N, 0};
  SolverVars_t sv = {
      &tab,
      &pivots,
      malloc(fps * M),    // x
      malloc(fps * M),    // u
      malloc(fps * N),    // v
      malloc(fps * Ngrad) // d_xuv
  };

  SolverOpt_t so = {0.1, 0.1, 1e-19, 0.1, 100};

  SolverStats_t ss = solve(&lp, &sv, so);

  printf("solution: \n");
  for (IDX k = 0; k < M; k++) {
    printf("%05.4lf ", sv.x[k]);
  }

  printf("\nd_xuv: \n");
  for (IDX k = 0; k < Ngrad; k++) {
    printf("%05.4lf ", sv.d_xuv[k]);
  }

  printf("\ngrad: \n");
  for (IDX k = 0; k < Ngrad * (Ngrad + 1); k++) {
    printf("%05.4lf ", tab.ptr[k]);
  }

  printf("\n\ngap = %05.4lf, iters = %lu\n", ss.gap, ss.iters);
}

void dual_solve_test_flattened() {
  FPN A[] = {1.0000, 1.0000,  1.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,
             0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,
             0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,
             1.0000, 1.0000,  1.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,
             0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,
             0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,
             1.0000, 1.0000,  1.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,
             0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,  0.0000, -1.0000,
             0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,
             1.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,
             0.0000, 0.0000,  0.0000, 0.0000,  0.0000, -1.0000, 0.0000, 0.0000,
             0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,  1.0000, 0.0000,
             0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,
             0.0000, 0.0000,  0.0000, -1.0000, 0.0000, 0.0000,  0.0000, 0.0000,
             0.0000, 0.0000,  0.0000, 0.0000,  1.0000, 0.0000,  0.0000, 0.0000,
             0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,
             0.0000, -1.0000, 0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,
             0.0000, 0.0000,  1.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,
             0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,  0.0000, -1.0000,
             0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,
             1.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,
             0.0000, 0.0000,  0.0000, 0.0000,  0.0000, -1.0000, 0.0000, 0.0000,
             0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,  1.0000, 0.0000,
             0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,
             0.0000, 0.0000,  0.0000, -1.0000, 0.0000, 0.0000,  0.0000, 0.0000,
             0.0000, 0.0000,  0.0000, 0.0000,  1.0000, 0.0000,  0.0000, 0.0000,
             0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,
             0.0000, -1.0000, 0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,
             0.0000, 0.0000,  1.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,
             0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,  0.0000, -1.0000,
             0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,
             1.0000, 0.0000,  0.0000, 0.0000,  1.0000, 0.0000,  0.0000, 1.0000,
             0.0000, 0.0000,  1.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,
             0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,  1.0000, 0.0000,
             0.0000, 0.0000,  1.0000, 0.0000,  0.0000, 1.0000,  0.0000, 0.0000,
             1.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,
             0.0000, 0.0000,  0.0000, 0.0000,  1.0000, 0.0000,  0.0000, 0.0000,
             1.0000, 0.0000,  0.0000, 1.0000,  0.0000, 0.0000,  1.0000, 0.0000,
             0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,
             0.0000, 0.0000,  1.0000};

  FPN b[] = {0.5849, 0.4773, 0.7167, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000,
             0.0000, 0.0000, 0.0000, 0.0000, 0.5680, 1.7806, 0.2493};

  FPN c[] = {0.1464, 0.1146, 0.0824, 0.2305, 0.0715,
             0.1266, 0.0308, 0.0564, 0.1408};

  IDX N = 15;
  IDX M = 21;

  dual_solve_test_general(&A, &b, &c, N, M);
}

void dual_solve_test_simple() {
  FPN A[] = {0.4753, 0.7483, 0.1001, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,
             0.0000, 0.3721, 0.2321, 0.1831,  0.0000, 0.0000,  0.0000, 0.0000,
             0.0000, 0.0000, 0.2676, 0.4110,  0.4571, 0.0000,  0.0000, 0.0000,
             0.0000, 0.0000, 0.0000, -1.0000, 0.0000, 0.0000,  1.0000, 0.0000,
             0.0000, 0.0000, 0.0000, 0.0000,  0.0000, -1.0000, 0.0000, 0.0000,
             1.0000, 0.0000, 0.0000, 0.0000,  0.0000, 0.0000,  0.0000, -1.0000,
             0.0000, 0.0000, 1.0000, 0.0000,  0.0000, 0.0000,  0.2840, 0.8903,
             0.1246, 0.0000, 0.0000, 0.0000,  1.0000, 0.0000,  0.0000, 0.7034,
             0.4756, 0.6028, 0.0000, 0.0000,  0.0000, 0.0000,  1.0000, 0.0000,
             0.2263, 0.2783, 0.8207, 0.0000,  0.0000, 0.0000,  0.0000, 0.0000,
             1.0000};

  FPN b[] = {0.5849, 0.4773, 0.7167, 0.0000, 0.0000,
             0.0000, 3.8762, 1.3224, 2.8001};

  FPN c[] = {0.8888, 0.9051, 0.1765};

  IDX N = 9;
  IDX M = 9;

  dual_solve_test_general(&A, &b, &c, N, M);
}

int main() {
  printf("GJ:\n");
  gauss_jordan_test();

  printf("\n\nLP solve:\n");
  dual_solve_test_simple();

  return 0;
}
